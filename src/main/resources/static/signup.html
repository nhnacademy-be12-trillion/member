<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>추가 정보 입력</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #f0f2f5; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 350px; } /* 너비 확장 */
        input { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        h2 { text-align: center; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <h2>회원가입 마무리</h2>
    <p>소셜 인증이 완료되었습니다. 서비스 이용을 위해 추가 정보를 입력해주세요.</p>

    <label>이메일</label>
    <input type="text" id="email" readonly style="background-color: #e9ecef;">

    <label>이름</label>
    <input type="text" id="name" readonly style="background-color: #e9ecef;">

    <label>생년월일</label>
    <input type="date" id="birthDate" required>

    <label>연락처</label>
    <input type="text" id="contact" placeholder="010-0000-0000" required>

    <hr style="margin: 15px 0;">

    <label>우편번호</label>
    <input type="text" id="postCode" placeholder="우편번호" required>

    <label>기본 주소 (도로명)</label>
    <input type="text" id="baseAddress" placeholder="기본 주소" required>

    <label>상세 주소</label>
    <input type="text" id="detailAddress" placeholder="상세 주소" required>

    <label>주소 별칭</label>
    <input type="text" id="addressAlias" placeholder="예: 집, 회사" required>

    <input type="hidden" id="oauthId">

    <button onclick="submitSignup()">가입 완료</button>
</div>

<script>
    // URL 파라미터에서 데이터 추출
    const urlParams = new URLSearchParams(window.location.search);
    const email = urlParams.get('email');
    const name = urlParams.get('name');
    const oauthId = urlParams.get('oauthId'); // ⭐️ OAuth ID 추출

    // 화면에 표시 및 숨김 필드에 저장
    document.getElementById('email').value = email;
    document.getElementById('name').value = name;
    document.getElementById('oauthId').value = oauthId; // ⭐️ 숨김 필드에 저장

    // 가입 요청 함수
    function submitSignup() {
        // 필수 필드 값 수집
        const birthDate = document.getElementById('birthDate').value;
        const contact = document.getElementById('contact').value;

        // 주소 필드 값 수집
        const postCode = document.getElementById('postCode').value;
        const baseAddress = document.getElementById('baseAddress').value;
        const detailAddress = document.getElementById('detailAddress').value;
        const addressAlias = document.getElementById('addressAlias').value;

        // 클라이언트 측 유효성 검사 (서버에서도 하지만, UX 개선을 위해)
        if (!birthDate || !contact || !postCode || !baseAddress || !detailAddress || !addressAlias) {
            alert("필수 항목을 모두 입력해주세요.");
            return;
        }

        // SocialSignupRequest DTO 구조에 맞게 JSON 생성
        const data = {
            email: email,
            name: name,
            birthDate: birthDate,
            contact: contact,
            memberOauthId: oauthId,

            // ⭐️ AddressCreateRequest DTO 매핑
            address: {
                addressPostCode: postCode,
                addressBase: baseAddress,
                addressDetail: detailAddress,
                addressAlias: addressAlias
            }
        };

        // API 호출
        fetch('/api/members/signup/social', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    alert("가입이 완료되었습니다! 다시 로그인해주세요.");
                    window.location.href = '/login.html'; // 로그인 페이지로 이동
                } else {
                    // 서버에서 보낸 ErrorResponse JSON을 파싱하여 메시지 출력
                    response.json().then(err => {
                        let msg = err.message || "서버에서 오류가 발생했습니다.";
                        if (err.validationErrors) { // @Valid 오류가 있을 경우 상세 메시지 추가
                            msg += "\n상세: " + Object.values(err.validationErrors).join(", ");
                        }
                        alert("가입 실패: " + msg);
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("네트워크 오류가 발생했습니다.");
            });
    }
</script>
</body>
</html>