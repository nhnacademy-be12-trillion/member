### 환경 변수 설정
@host = http://localhost:8080
@contentType = application/json
@testEmail = shhk2100@gmail.com
@testPassword = password1234
@testName = 테스트

### =======================================================================
### 1. 인증 및 회원가입 프로세스
### =======================================================================

### 1-1. 이메일 인증번호 발송
POST {{host}}/api/members/emails
Content-Type: {{contentType}}

{
  "email": "{{testEmail}}"
}

### 1-2. 이메일 인증번호 검증
# 실제 이메일로 수신된 코드를 입력
POST {{host}}/api/members/emails/verify
Content-Type: {{contentType}}

{
  "email": "{{testEmail}}",
  "code": "717952"
}

### 1-3. 회원가입 (포인트 자동 적립 포함)
POST {{host}}/api/members/signup
Content-Type: {{contentType}}

{
  "memberEmail": "{{testEmail}}",
  "verificationCode": "196272",
  "memberPassword": "{{testPassword}}",
  "memberName": "{{testName}}",
  "memberContact": "01012345678",
  "memberBirth": "2000-01-01",
  "address": {
    "addressPostCode": "12345",
    "addressBase": "광주광역시",
    "addressDetail": "아카데미",
    "addressAlias": "학교"
  }
}

### 1-4. 로그인 (토큰 자동 저장 스크립트 포함)
# 이 요청을 실행해야 이후 모든 요청의 토큰이 자동으로 설정.
POST {{host}}/api/auth/login
Content-Type: {{contentType}}

{
  "memberEmail": "{{testEmail}}",
  "memberPassword": "{{testPassword}}"
}

> {%
    // 응답 헤더에서 토큰 추출 및 전역 변수 저장
    client.global.set("accessToken", response.headers.valueOf("Authorization").replace("Bearer ", ""));
    client.global.set("refreshToken", response.headers.valueOf("Refresh-Token"));

    client.log("Access Token Set: " + client.global.get("accessToken"));
%}

### 1-5. 토큰 재발급
POST {{host}}/api/auth/reissue
Refresh-Token: {{refreshToken}}

> {%
    // 응답 헤더에서 토큰 추출 및 전역 변수 저장
    client.global.set("accessToken", response.headers.valueOf("Authorization").replace("Bearer ", ""));
    client.global.set("refreshToken", response.headers.valueOf("Refresh-Token"));

    client.log("Access Token Set: " + client.global.get("accessToken"));
%}

### =======================================================================
### 2. 회원 정보 관리
### =======================================================================

### 2-1. 내 정보 조회
GET {{host}}/api/members
Authorization: Bearer {{accessToken}}

### 2-2. 이메일 찾기 (이름 + 전화번호)
POST {{host}}/api/members/findEmail
Content-Type: {{contentType}}

{
  "memberName": "{{testName}}",
  "memberContact": "01012345678"
}

### 2-3. 회원 정보 수정
PUT {{host}}/api/members
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "memberPassword": "password1234",
  "memberName": "test",
  "memberContact": "010-8765-4321"
}

### 2-4. 비밀번호 재설정
PUT {{host}}/api/members/password/reset
Content-Type: {{contentType}}

{
  "memberEmail": "{{testEmail}}",
  "verificationCode": "468621",
  "newPassword": "NewPassword123!"
}

### =======================================================================
### 3. 주소(Address) 관리
### =======================================================================

### 3-1. 주소 등록
POST {{host}}/api/members/addresses
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "addressPostCode": "54321",
  "addressBase": "서울시 강남구",
  "addressDetail": "테헤란로",
  "addressAlias": "본사"
}

### 3-2. 전체 주소 조회
GET {{host}}/api/members/addresses
Authorization: Bearer {{accessToken}}

### 3-3. 특정 주소 조회 (ID: 1)
GET {{host}}/api/members/addresses/1
Authorization: Bearer {{accessToken}}

### 3-4. 주소 수정
PUT {{host}}/api/members/addresses
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "addressId": 1,
  "addressPostCode": "67890",
  "addressBase": "부산광역시 해운대구",
  "addressDetail": "센텀시티",
  "addressAlias": "지사"
}

### 3-5. 주소 삭제
DELETE {{host}}/api/members/addresses/1
Authorization: Bearer {{accessToken}}

### =======================================================================
### 4. 포인트(Point) 시스템 (적립/사용/내역)
### =======================================================================

### 4-1. 마이페이지 포인트 내역 조회
GET {{host}}/api/members/points/histories
Authorization: Bearer {{accessToken}}


### 4-2. 회원가입 포인트 적립
POST {{host}}/api/members/points/signup
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}


### 4-3. 도서 구매 포인트 적립 (주문 서비스 연동)
# DTO: BookPointRequest (orderId, amount)
POST {{host}}/api/members/points/purchase
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "orderId": 1001,
  "amount": 50000
}


### 4-4. 리뷰 작성 포인트 적립 (리뷰 서비스 연동 - 사진 있음)
# DTO: ReviewPointRequest (reviewId, hasPhoto)
# 사진 포함 시 정책에 따라(예: 300+200=500P) 적립
POST {{host}}/api/members/points/review
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "reviewId": 5001,
  "hasPhoto": true
}

### 4-5. 리뷰 작성 포인트 적립 (리뷰 서비스 연동 - 사진 없음)
# DTO: ReviewPointRequest (reviewId, hasPhoto)
# 사진 미포함 시 정책에 따라(예: 200P) 적립
# reviewId는 중복되면 에러가 발생하므로, 테스트를 위해 5002로 변경
POST {{host}}/api/members/points/review
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "reviewId": 5002,
  "hasPhoto": false
}


### 4-6. 포인트 결제 사용 (주문 서비스 연동)
# DTO: PointUseRequest (orderId, amount)
POST {{host}}/api/members/points/use
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "orderId": 1002,
  "amount": 2000
}


### 4-7. 도서 반품 시 포인트 회수 (Order Service -> Member Service)
# DTO: PointRefundRequest (memberId, orderId)
# 4-3에서 적립된 주문(orderId: 1001)의 포인트를 회수.
# ⭐️ memberId는 Order Service에서 전송하므로, 테스트를 위해 1로 가정.
POST {{host}}/api/members/points/refund
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "memberId": 1,
  "orderId": 1001
}


### =======================================================================
### 5. 포인트 정책(Point Policy) 관리 (관리자용)
### =======================================================================

### 5-1. 포인트 정책 전체 조회
# 요청 경로: /api/admin/points/policies 가 일반적이지만, 요청하신 경로를 사용합니다.
GET {{host}}/api/members/admin/points/policies
Authorization: Bearer {{accessToken}}


### 5-2. 포인트 정책 수정 (RATE 타입 - 도서 구매 적립률 변경)
# DTO: PointPolicyUpdateRequest (pointPolicyName, pointPolicyType, pointPolicyRate, pointPolicyFixedAmount)
# 정책 이름 수정 가능, RATE 변경
PUT {{host}}/api/members/admin/points/policies/1
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "pointPolicyName": "도서 구매 기본 적립",
  "pointPolicyType": "RATE",
  "pointPolicyRate": 0.05,
  "pointPolicyFixedAmount": null
}


### 5-3. 포인트 정책 수정 (AMOUNT 타입 - 회원가입 고정금액 변경)
# DTO: PointPolicyUpdateRequest
# 정책 이름 수정 가능, AMOUNT 변경
PUT {{host}}/api/members/admin/points/policies/2
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "pointPolicyName": "신규 회원 환영 이벤트 적립금",
  "pointPolicyType": "AMOUNT",
  "pointPolicyRate": null,
  "pointPolicyFixedAmount": 3000
}
### =======================================================================
### 6. 등급(Grade) 관리
### =======================================================================

### 6-1. 전체 등급 목록 조회
GET {{host}}/api/members/grades
Authorization: Bearer {{accessToken}}

### 6-2. 특정 등급 조회
GET {{host}}/api/members/grades/1
Authorization: Bearer {{accessToken}}

### 6-3. 등급 정보 수정
PUT {{host}}/api/members/grades/3
Authorization: Bearer {{accessToken}}
Content-Type: {{contentType}}

{
  "gradeName": "GOLD",
  "gradePointRatio": 0.01,
  "gradeCondition": 100000
}

### =======================================================================
### 7. 로그아웃 및 탈퇴
### =======================================================================

### 7-1. 로그아웃
POST {{host}}/api/auth/logout
Authorization: Bearer {{accessToken}}
Refresh-Token: {{refreshToken}}

### 7-2. 회원 탈퇴
POST {{host}}/api/members/withdraw
Authorization: Bearer {{accessToken}}
Refresh-Token: {{refreshToken}}